<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Image Puzzle Reveal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 20px;
        }

        canvas {
            margin-top: 20px;
            border: 1px solid black;
        }

        #logs {
            margin-top: 20px;
            font-size: 0.8em;
            text-align: left;
            max-width: 600px;
            margin: 20px auto;
            background-color: #f0f0f0;
            padding: 10px;
            border: 1px solid #ccc;
            height: 200px;
            overflow-y: scroll;
        }

        .log-entry {
            border-bottom: 1px solid #ccc;
            padding: 2px 0;
        }

        button {
            margin-top: 20px;
            font-size: 1.2em;
            padding: 10px 20px;
        }
    </style>
</head>
<body>
    <h2>Image Puzzle Reveal Game</h2>
    <div>Credits: <span id="creditsDisplay">200</span></div>
    <input type="file" id="imageUpload" accept="image/*">
    <button id="startGameButton">Start Game</button>
    <button id="openGovernorButton">Open Governor</button>
    <canvas id="imageCanvas"></canvas>
    <div id="logs"></div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-functions-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let db, auth, callNumber, img, blocks = [], blockSize = 50;
            let userCredits = 200, maxTilesPerRequest = 10;
            const startGameButton = document.getElementById('startGameButton');
            const openGovernorButton = document.getElementById('openGovernorButton');
            const imageUpload = document.getElementById('imageUpload');
            const canvas = document.getElementById('imageCanvas');
            const ctx = canvas.getContext('2d');
            let governorWindow;
            let userId, currentUserIndex = 0, users = [];
            let roomNumber;

            function logToHTML(message) {
                const logContainer = document.getElementById('logs');
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = message;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            async function getFirebaseConfig() {
                try {
                    const response = await fetch('https://us-central1-imagetilegame.cloudfunctions.net/getFirebaseConfig', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: '{}'
                    });
                    if (!response.ok) throw new Error('Network response was not ok');
                    return await response.json();
                } catch (error) {
                    logToHTML('Failed to fetch Firebase config: ' + error);
                    return null;
                }
            }

            function prepareCanvas() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                logToHTML('Canvas prepared with dimensions: ' + canvas.width + 'x' + canvas.height);
            }

            function prepareBlocks() {
                blocks = [];
                for (let y = 0; y < img.height; y += blockSize) {
                    for (let x = 0; x < img.width; x += blockSize) {
                        blocks.push({ x, y, placed: false });
                    }
                }
                logToHTML('Blocks prepared: ' + blocks.length + ' blocks created.');
            }

            function drawBlocks() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                blocks.forEach(block => {
                    if (block.placed) {
                        ctx.drawImage(img, block.x, block.y, blockSize, blockSize, block.x, block.y, blockSize, blockSize);
                    }
                });
                logToHTML('Blocks drawn.');
            }

            function updateCreditsDisplay(credits) {
                document.getElementById('creditsDisplay').textContent = credits;
            }

            function switchTurn() {
                currentUserIndex = (currentUserIndex + 1) % users.length;
                const currentUser = users[currentUserIndex];
                logToHTML(`It's now ${currentUser.userName}'s turn.`);
            }

            async function updateCredits(userId, amount) {
                const userRef = db.collection('users').doc(userId);
                await userRef.update({
                    credits: firebase.firestore.FieldValue.increment(amount)
                });
                const doc = await userRef.get();
                updateCreditsDisplay(doc.data().credits);
            }

            function letterPairToNumber(pair) {
                const letterMapping = {
                    'AB': 1,
                    'CD': 2,
                    'EF': 3,
                    'GH': 4,
                    'IJ': 5,
                    'KL': 6,
                    'MN': 7,
                    'OP': 8,
                    'QR': 9,
                    'ST': 10,
                    'UV': 11,
                    'WX': 12,
                    'YZ': 13
                };
                return letterMapping[pair.toUpperCase()] || 0;
            }

            imageUpload.addEventListener('change', function (e) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    img = new Image();
                    img.onload = function () {
                        logToHTML('Image loaded with dimensions: ' + img.width + 'x' + img.height);
                        prepareCanvas();
                        prepareBlocks();
                    }
                    const fileName = e.target.files[0].name.split('.')[0]; // Extract file name without extension
                    roomNumber = letterPairToNumber(fileName);
                    img.src = event.target.result;
                }
                reader.readAsDataURL(e.target.files[0]);
            });

            startGameButton.addEventListener('click', async () => {
                const config = await getFirebaseConfig();
                if (!config) {
                    logToHTML("Error: Firebase config is null");
                    return;
                }

                logToHTML("Firebase config fetched: " + JSON.stringify(config));
                firebase.initializeApp(config);
                db = firebase.firestore();
                auth = firebase.auth();

                auth.signInAnonymously().catch(error => {
                    logToHTML('Failed to sign in anonymously: ' + error.message);
                });

                auth.onAuthStateChanged(async user => {
                    if (user) {
                        userId = user.uid;
                        logToHTML("User signed in anonymously: " + user.uid);

                        // Initialize users with 200 credits if they are new
                        const userRef = db.collection('users').doc(userId);
                        const doc = await userRef.get();
                        if (!doc.exists) {
                            await userRef.set({ credits: 200, turn: users.length === 0 });
                            users.push({ userId, userName: prompt("Enter your name:") });
                        } else {
                            users.push({ userId, userName: prompt("Enter your name:") });
                            updateCreditsDisplay(doc.data().credits);
                        }

                        callNumber = Math.floor(Math.random() * 900000) + 100000;
                        logToHTML(`Game s
